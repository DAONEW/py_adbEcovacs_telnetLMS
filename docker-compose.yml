services:
  telnet_squeezelite:
    image: ghcr.io/daonew/py_adbecovacs_telnetlms/telnet_squeezelite:latest
    pull_policy: always
    container_name: telnet_squeezelite
    restart: unless-stopped
    network_mode: host
    env_file:
      - .env
    volumes:
      - telnet_logs:/app/logs

  adb_ecovacs:
    image: ghcr.io/daonew/py_adbecovacs_telnetlms/adb_ecovacs:latest
    pull_policy: always
    container_name: adb_ecovacs
    restart: unless-stopped
    network_mode: host
    privileged: true
    devices:
      - "/dev/bus/usb:/dev/bus/usb"
    env_file:
      - .env
    command: >
      /bin/sh -c '
        set -euo pipefail
        key_path="$${MAP_UPLOAD_SSH_KEY_PATH:-/root/.ssh/id_adb_ecovacs}"
        kh_path="$${MAP_UPLOAD_SSH_KNOWN_HOSTS_PATH:-/root/.ssh/known_hosts}"
        ssh_dir="$(dirname "$${key_path}")"
        install -d -m 700 "$$ssh_dir"
        if [ -n "$${SSH_PRIVATE_KEY_BASE64:-}" ]; then
          printf "%s" "$$SSH_PRIVATE_KEY_BASE64" | base64 -d > "$$key_path"
          chmod 600 "$$key_path"
        fi
        if [ -n "$${SSH_KNOWN_HOSTS_BASE64:-}" ]; then
          install -d -m 700 "$(dirname "$${kh_path}")"
          printf "%s" "$$SSH_KNOWN_HOSTS_BASE64" | base64 -d > "$$kh_path"
          chmod 644 "$$kh_path"
        fi
        exec python adb_ecovacs/ecovacs_app.py
      '

volumes:
  telnet_logs:
